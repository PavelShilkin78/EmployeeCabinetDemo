импорт ОбщиеСтандартные
импорт ФизическиеЛица
импорт Компания
импорт ВебApi
импорт КонтрольДоступа

//Область РазрешенияДоступа

@Обработчик
метод ВычислитьРазрешенияДоступа(): Массив<РазрешениеДоступа>
    возврат [КонтрольДоступа.ЧтениеАутентифицированным(этот),
            КонтрольДоступа.ПолныйДоступИнформационнойСистеме(этот)]
;

@Обработчик
метод ВычислитьРазрешенияДоступаДляОбъектов(Элементы: ЧитаемыйМассив<ПрименениеВычетовНаДетей.ДанныеРасчетаРазрешений>): ЧитаемоеСоответствие<ПрименениеВычетовНаДетей.ДанныеРасчетаРазрешений, ЧитаемаяКоллекция<РазрешениеДоступа>>
    знч Разрешения: Соответствие<ПрименениеВычетовНаДетей.ДанныеРасчетаРазрешений, ЧитаемаяКоллекция<РазрешениеДоступа>>
    для Элемент из Элементы
        знч РазрешенияЭлемента: Множество<РазрешениеДоступа>
        РазрешенияЭлемента.Добавить(КонтрольДоступа.ПолныйДоступИнформационнойСистеме(этот))
        РазрешенияЭлемента.ДобавитьВсе(КонтрольДоступа.ЧтениеДанныхСправочниковПоПолномочиям(
            [Зарплата.ПолномочиеПросмотрНдфл()],
            Элемент.ФизическоеЛицо
        ))
        РазрешенияЭлемента.ДобавитьВсе(КонтрольДоступа.ЧтениеДанныхСправочниковПерсонально([Элемент.ФизическоеЛицо]))
        Разрешения.Вставить(Элемент, РазрешенияЭлемента)
    ;
    возврат Разрешения
;

//КонецОбласти

//Область JSON

@ВПодсистеме
метод ТипДанныхJson(ВерсияФорматаОбмена: Версия?): Тип
    если ВерсияФорматаОбмена == Неопределено
        возврат Тип<ДанныеJson>
    иначе если ВерсияФорматаОбмена >= Версия{1.0}
        возврат Тип<ДанныеJson>
    ;
;

@ВПодсистеме
метод ТипКоллекцииДанныхJson(ВерсияФорматаОбмена: Версия?): Тип
    если ВерсияФорматаОбмена == Неопределено
        возврат Тип<Массив<ДанныеJson>>
    иначе если ВерсияФорматаОбмена >= Версия{1.0}
        возврат Тип<Массив<ДанныеJson>>
    ;
;

@ВПроекте
структура ДанныеJson
    обз знч personID: Строка
    обз знч employerID: Строка
    @JsonСвойство(Имя = "use")
    обз знч _use: Булево
    обз знч note: Строка?
;

@ВПодсистеме
метод ТипОбъектаJson(): Строка
    возврат "childTaxDeductions"
;

@ВПодсистеме
метод ЗагрузитьОбъектИзJson(ДанныеJson: ДанныеJson, Сервисы: ВебApiСервер.СервисыЗагрузкиJson)
    знч ФизическоеЛицо = Сервисы.ПолучитьСсылку(ФизическиеЛица.ВнешняяСсылка(ДанныеJson.personID)) как ФизическиеЛица.Ссылка
    знч ГоловнаяОрганизация = Сервисы.ПолучитьСсылку(Организации.ВнешняяСсылка(ДанныеJson.employerID)) как Организации.Ссылка
    
    знч Ключ: Соответствие<Строка, Объект>
    Ключ.Вставить("ФизическоеЛицо", ФизическоеЛицо)
    Ключ.Вставить("ГоловнаяОрганизация", ГоловнаяОрганизация)

    знч ПрименениеВычетовОбъект: ПрименениеВычетовНаДетей.Объект = новый ПрименениеВычетовНаДетей.Объект()
    ПрименениеВычетовОбъект.ГоловнаяОрганизация = ГоловнаяОрганизация
    ПрименениеВычетовОбъект.ФизическоеЛицо = ФизическоеЛицо
    ПрименениеВычетовОбъект.ПрименениеВычетов = ДанныеJson._use
    ПрименениеВычетовОбъект.Комментарий = ДанныеJson.note ?? ""

    Сервисы.ЗаписатьКоллекцию([ПрименениеВычетовОбъект], Ключ, Тип<ПрименениеВычетовНаДетей.Ссылка>, Сервисы.ИнструментыМенеджераОбъекта)
;

@ВПодсистеме
метод УдалитьОбъекты(ПараметрыЗапроса: ЧитаемоеСоответствие<Строка, Число|Булево|Ууид|Строка>, Сервисы: ВебApiСервер.СервисыУдаленияОбъектов)
    знч Ключ = {
        "ФизическоеЛицо": Сервисы.ПолучитьСсылку(ФизическиеЛица.ВнешняяСсылка(ПараметрыЗапроса["personID"] как Строка)),
        "ГоловнаяОрганизация": Сервисы.ПолучитьСсылку(Организации.ВнешняяСсылка(ПараметрыЗапроса["employerID"] как Строка))
    }
    Сервисы.УдалитьКоллекцию(Ключ, Тип<ПрименениеВычетовНаДетей.Ссылка>)
;

метод ДанныеПрименяемыхВычетов(ФизическоеЛицо: ФизическиеЛица.Ссылка, ГоловнаяОрганизация: Организации.Ссылка): Соответствие<Строка, Объект?>
    знч Запрос = Запрос{
        Выбрать 
            ФизическоеЛицо,
            ГоловнаяОрганизация,
            ПрименениеВычетов,
            Комментарий
        Из 
            ПрименениеВычетовНаДетей
        Где
            ФизическоеЛицо == %ФизическоеЛицо
            И ГоловнаяОрганизация == %ГоловнаяОрганизация}
    
    пер Вычеты: Массив<ЧитаемоеСоответствие<Строка, Объект?>>
    исп Результат = Запрос.Выполнить() 
    для РезультатСтрока из Результат
        Вычеты.Добавить(МенеджерЗапросов.СтрокаРезультатаЗапросаВСоответствие(РезультатСтрока, Результат))
    ;
    возврат <Строка, Объект?>{
        "ФизическоеЛицо": ФизическоеЛицо,
        "ГоловнаяОрганизация": ГоловнаяОрганизация,
        "Элементы": Вычеты}
;

//КонецОбласти
