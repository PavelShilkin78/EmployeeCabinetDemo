импорт Почта
импорт ИнтерфейсныеКомпонентыСтандартные
импорт КонтрольДоступа

// Блок инициализации

@Обработчик
метод ПослеСоздания()
    Компоненты.УчетнаяЗаписьПочтыКомпонет.Инициализировать()
    УстановитьЗаголовок()
;

// Конец инициализации

// Блок управления интерфейсом

метод УстановитьЗаголовок()
    НоваяЗапись = Компоненты.УчетнаяЗаписьПочтыКомпонет.Новая()
    если НоваяЗапись
        ЗаголовокКарточки = "Создать учетную запись"
    иначе
        ЗаголовокКарточки = "Редактировать учетную запись"
    ;
;

// Конец управления интерфейсом

// Блок обработки событий клиента

метод СохранитьУчетнуюЗапись(Команда: ОбычнаяКоманда)
    если Компоненты.УчетнаяЗаписьПочтыКомпонет.Записать()
        УстановитьНастройкиШлюзовСпискаПользователей(Почта.ИД_ПОДСИСТЕМЫ)
        СтандартныеФормы.ПоказатьУведомление("Сохранение данных", 
            "Данные успешно записаны, не забудьте проверить оптправку письма", 
            ОценкаИнформации.Положительная)
        УстановитьЗаголовок()
    ;
;

метод ЗапуститьПроверкуУчетнойЗаписи(Команда: ОбычнаяКоманда)
    ПроверкаПочтыФорма.ОткрытьВМодальномОкне(
        УчетнаяЗапись = Компоненты.УчетнаяЗаписьПочтыКомпонет.УчетнаяЗаписьОбъект.Ссылка
    )
;

// Конец обработки событий клиента

// Блок чтения и записи данных

@НаСервере @ДоступноСКлиента
статический метод УстановитьНастройкиШлюзовСпискаПользователей(ИдПодсистемы: Строка)
    пер ДанныеПодключения = УчетныеЗаписиПочты.ПодключениеПодсистемы(ИдПодсистемы)
    если ДанныеПодключения != Неопределено
        пер НастройкиШлюза = Почта.НастройкиШлюза(ДанныеПодключения)
        исп КонтекстДоступа.Привилегированный()
        ПользователиСистемы.УстановитьШлюзSmtp(НастройкиШлюза)
    иначе
        выбросить новый ИсключениеВыполнения("Отсутствуют настройки системной учетной записи почты.")
    ;
;

// Конец чтения и записи данных