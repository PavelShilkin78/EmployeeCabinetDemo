импорт ВебApi
импорт ОбменДанными

//Контракт ДанныеApi
@ВПроекте
@Реализация
метод МассивТипов(Получатель: ВидПриложения?, ВерсияФорматаОбмена: Версия?): Массив<Тип>
    пер Типы: Массив<Тип>
    если Получатель == ВидПриложения.Hr
        Типы.Добавить(Тип<Анкеты.Ссылка>)
        Типы.Добавить(Тип<Ответы.Ссылка>)
    иначе если Получатель == ВидПриложения.Ess
        Типы.Добавить(Тип<Опросы.Ссылка>)
        Типы.Добавить(Тип<Анкеты.Ссылка>)
        Типы.Добавить(Тип<ШаблоныАнкет.Ссылка>)
        Типы.Добавить(Тип<ВопросыШаблоновАнкет.Ссылка>)
        Типы.Добавить(Тип<Вопросы.Ссылка>)
        Типы.Добавить(Тип<РазделыАнкет.Ссылка>)
        Типы.Добавить(Тип<НаборыВариантовОтвета.Ссылка>)
        Типы.Добавить(Тип<ВариантыОтветов.Ссылка>)
    ;
    возврат Типы
;

@ВПроекте
@Реализация
метод ТипДанныхJson(ТипОбъекта: Тип, ВерсияФорматаОбмена: Версия?): Массив<Тип>
    пер Типы: Массив<Тип>
    выбор ТипОбъекта
    когда Тип<ШаблоныАнкет.Ссылка>
        Типы.Добавить(ШаблоныАнкетDto.ТипДанныхJson(ВерсияФорматаОбмена))
    когда Тип<Анкеты.Ссылка>
        Типы.Добавить(АнкетыDto.ТипДанныхJson(ВерсияФорматаОбмена))
    когда Тип<Опросы.Ссылка>
        Типы.Добавить(ОпросыDto.ТипДанныхJson(ВерсияФорматаОбмена))
    когда Тип<ВариантыОтветов.Ссылка>
        Типы.Добавить(ВариантыОтветовDto.ТипДанныхJson(ВерсияФорматаОбмена))
    когда Тип<Вопросы.Ссылка>
        Типы.Добавить(ВопросыDto.ТипДанныхJson(ВерсияФорматаОбмена))
    когда Тип<ВопросыШаблоновАнкет.Ссылка>
        Типы.Добавить(ВопросыШаблоновАнкетDto.ТипДанныхJson(ВерсияФорматаОбмена))
    когда Тип<НаборыВариантовОтвета.Ссылка>
        Типы.Добавить(НаборыВариантовОтветаDto.ТипДанныхJson(ВерсияФорматаОбмена))  
    когда Тип<РазделыАнкет.Ссылка>
        Типы.Добавить(РазделыАнкетDto.ТипДанныхJson(ВерсияФорматаОбмена))
    когда Тип<Ответы.Ссылка>
        Типы.Добавить(ОтветыDto.ТипДанныхJson(ВерсияФорматаОбмена))  
    ;
    возврат Типы
;

@ВПроекте
@Реализация
метод ТипКоллекцииДанныхJson(ТипОбъекта: Тип, ВерсияФорматаОбмена: Версия?): Массив<Тип>
    пер Типы: Массив<Тип>
    возврат Типы
;

@ВПроекте
@Реализация
метод ИнструментыМенеджераОбъекта(ТипОбъекта: Тип): Массив<ВебApiСервер.ИнструментыМенеджераОбъекта>
    пер НаборИнструментыМенеджераОбъекта: Массив<ВебApiСервер.ИнструментыМенеджераОбъекта>
    пер ИнструментыМенеджераОбъекта: ВебApiСервер.ИнструментыМенеджераОбъекта
    выбор ТипОбъекта
    когда Тип<ВариантыОтветов.Ссылка>
        ИнструментыМенеджераОбъекта.ЗаписьОбъекта = (Объект: Сущность.Объект) -> (Объект как ВариантыОтветов.Объект).Записать()
        НаборИнструментыМенеджераОбъекта.Добавить(ИнструментыМенеджераОбъекта)
    когда Тип<Вопросы.Ссылка>
        ИнструментыМенеджераОбъекта.ЗаписьОбъекта = (Объект: Сущность.Объект) -> (Объект как Вопросы.Объект).Записать()
        НаборИнструментыМенеджераОбъекта.Добавить(ИнструментыМенеджераОбъекта)
    когда Тип<ВопросыШаблоновАнкет.Ссылка>
        ИнструментыМенеджераОбъекта.ЗаписьОбъекта = (Объект: Сущность.Объект) -> (Объект как ВопросыШаблоновАнкет.Объект).Записать()
        НаборИнструментыМенеджераОбъекта.Добавить(ИнструментыМенеджераОбъекта)
    когда Тип<НаборыВариантовОтвета.Ссылка>
        ИнструментыМенеджераОбъекта.ЗаписьОбъекта = (Объект: Сущность.Объект) -> (Объект как НаборыВариантовОтвета.Объект).Записать()
        НаборИнструментыМенеджераОбъекта.Добавить(ИнструментыМенеджераОбъекта)
    когда Тип<РазделыАнкет.Ссылка>
        ИнструментыМенеджераОбъекта.ЗаписьОбъекта = (Объект: Сущность.Объект) -> (Объект как РазделыАнкет.Объект).Записать()
        НаборИнструментыМенеджераОбъекта.Добавить(ИнструментыМенеджераОбъекта)
    когда Тип<ШаблоныАнкет.Ссылка>
        ИнструментыМенеджераОбъекта.ЗаписьОбъекта = (Объект: Сущность.Объект) -> (Объект как ШаблоныАнкет.Объект).Записать()
        НаборИнструментыМенеджераОбъекта.Добавить(ИнструментыМенеджераОбъекта)
    когда Тип<Анкеты.Ссылка>
        ИнструментыМенеджераОбъекта.ЗаписьОбъекта = (Объект: Сущность.Объект) -> (Объект как Анкеты.Объект).Записать()
        НаборИнструментыМенеджераОбъекта.Добавить(ИнструментыМенеджераОбъекта)
    когда Тип<Ответы.Ссылка>
        ИнструментыМенеджераОбъекта.ЗаписьОбъекта = (Объект: Сущность.Объект) -> (Объект как Ответы.Объект).Записать()
        НаборИнструментыМенеджераОбъекта.Добавить(ИнструментыМенеджераОбъекта)
    ;
    возврат НаборИнструментыМенеджераОбъекта
;

@ВПроекте
@Реализация
метод ПолучитьДанныеJson(ТипОбъекта: Тип, Ссылка: ВходящиеДанные.Ссылка|ИсходящиеДанные.Ссылка, 
        Сервисы: ВебApiСервер.СервисыУпаковкиJson, ВерсияФорматаОбмена: Версия?): Массив<Объект?>
    
    пер ДанныеJson: Массив<Объект?>
    возврат ДанныеJson
;

@ВПроекте
@Реализация
метод МассивСсылокПоФильтру(ТипОбъекта: Тип, Фильтр: () -> ЧитаемыйМассив<Справочник.Ссылка>): Массив<ЧитаемыйМассив<Справочник.Ссылка>>
    пер МассивСсылок: Массив<ЧитаемыйМассив<Справочник.Ссылка>>
    возврат МассивСсылок
;

@ВПроекте
@Реализация
метод УдалитьОбъекты(ТипОбъекта: Тип, ПараметрыЗапроса: ЧитаемоеСоответствие<Строка, Число|Булево|Ууид|Строка>, Сервисы: ВебApiСервер.СервисыУдаленияОбъектов)
    
;

@ВПроекте
@Реализация
метод ТипОбъектаJson(ТипОбъекта: Тип): Массив<Строка>
    пер ТипОбъектаJson: Массив<Строка>
    выбор ТипОбъекта
    когда Тип<ВариантыОтветов.Ссылка>
        ТипОбъектаJson.Добавить(ВариантыОтветовDto.ТипОбъектаJson())
    когда Тип<Вопросы.Ссылка>
        ТипОбъектаJson.Добавить(ВопросыDto.ТипОбъектаJson())
    когда Тип<ВопросыШаблоновАнкет.Ссылка>
        ТипОбъектаJson.Добавить(ВопросыШаблоновАнкетDto.ТипОбъектаJson())
    когда Тип<НаборыВариантовОтвета.Ссылка>
        ТипОбъектаJson.Добавить(НаборыВариантовОтветаDto.ТипОбъектаJson())
    когда Тип<РазделыАнкет.Ссылка>
        ТипОбъектаJson.Добавить(РазделыАнкетDto.ТипОбъектаJson())
    когда Тип<ШаблоныАнкет.Ссылка>
        ТипОбъектаJson.Добавить(ШаблоныАнкетDto.ТипОбъектаJson())
    когда Тип<Анкеты.Ссылка>
        ТипОбъектаJson.Добавить(АнкетыDto.ТипОбъектаJson())
    когда Тип<Ответы.Ссылка>
        ТипОбъектаJson.Добавить(ОтветыDto.ТипОбъектаJson())
    ;
    возврат ТипОбъектаJson
;

@ВПроекте
@Реализация
метод ЗагрузитьОбъектИзJson(ТипОбъекта: Тип, ТипДанных: Тип, ДанныеJson: Объект?, Сервисы: ВебApiСервер.СервисыЗагрузкиJson)
    выбор ТипОбъекта
    когда Тип<ШаблоныАнкет.Ссылка>
        выбор ТипДанных
        когда Тип<ШаблоныАнкетDto.ШаблонАнкеты_2_0>
            ШаблоныАнкетDto.ЗагрузитьОбъектИзJson(ДанныеJson как ШаблоныАнкетDto.ШаблонАнкеты_2_0, Сервисы)
        когда Тип<ШаблоныАнкетDto.ШаблонАнкеты_3_0>
            ШаблоныАнкетDto.ЗагрузитьОбъектИзJson(ДанныеJson как ШаблоныАнкетDto.ШаблонАнкеты_3_0, Сервисы)
        ;
    когда Тип<Анкеты.Ссылка>
        выбор ТипДанных
        когда Тип<АнкетыDto.Анкета_2_0>
            АнкетыDto.ЗагрузитьОбъектИзJson(ДанныеJson как АнкетыDto.Анкета_2_0, Сервисы)
        ;
    когда Тип<ВариантыОтветов.Ссылка>
        выбор ТипДанных
        когда Тип<ВариантыОтветовDto.ВариантОтвета_2_0>
            ВариантыОтветовDto.ЗагрузитьОбъектИзJson(ДанныеJson как ВариантыОтветовDto.ВариантОтвета_2_0, Сервисы)
        ;
    когда Тип<Вопросы.Ссылка>
        выбор ТипДанных
        когда Тип<ВопросыDto.Вопрос_2_0>
            ВопросыDto.ЗагрузитьОбъектИзJson(ДанныеJson как ВопросыDto.Вопрос_2_0, Сервисы)
        ;
    когда Тип<ВопросыШаблоновАнкет.Ссылка>
        выбор ТипДанных
        когда Тип<ВопросыШаблоновАнкетDto.ВопросШаблонаАнкеты_2_0>
            ВопросыШаблоновАнкетDto.ЗагрузитьОбъектИзJson(ДанныеJson как ВопросыШаблоновАнкетDto.ВопросШаблонаАнкеты_2_0, Сервисы)
        ;
    когда Тип<НаборыВариантовОтвета.Ссылка>
        выбор ТипДанных
        когда Тип<НаборыВариантовОтветаDto.НаборВариантов_2_0>
            НаборыВариантовОтветаDto.ЗагрузитьОбъектИзJson(ДанныеJson как НаборыВариантовОтветаDto.НаборВариантов_2_0, Сервисы)
        ;
    когда Тип<РазделыАнкет.Ссылка>
        выбор ТипДанных
        когда Тип<РазделыАнкетDto.РазделАнкеты_2_0>
            РазделыАнкетDto.ЗагрузитьОбъектИзJson(ДанныеJson как РазделыАнкетDto.РазделАнкеты_2_0, Сервисы)
        ;
    когда Тип<Опросы.Ссылка>
        выбор ТипДанных
        когда Тип<ОпросыDto.Опрос_2_0>
            ОпросыDto.ЗагрузитьОбъектИзJson(ДанныеJson как ОпросыDto.Опрос_2_0, Сервисы)
        ;
    когда Тип<Ответы.Ссылка>
        выбор ТипДанных
        когда Тип<ОтветыDto.Ответ_2_0>
            ОтветыDto.ЗагрузитьОбъектИзJson(ДанныеJson как ОтветыDto.Ответ_2_0, Сервисы)
        ;
    ;
;

@ВПроекте
@Реализация
метод ПослеЗаписиГруппыОбъектов(ТипОбъекта: Тип, МассивОбъектовОтложенногоОбновления: Массив<ВебApiСервер.ОбъектОтложенногоОбновления>)
;

@ВПроекте
@Реализация
метод ИзменитьОбъектИзJson(ТипОбъекта: Тип, ДанныеJson: Объект, Сервисы: ВебApiСервер.СервисыЗагрузкиJson, ЗаданиеМодификации: ВебApiСервер.ЗаданиеМодификации)
;

@ВПроекте
@Реализация
метод ЗавершитьИзменениеОбъектИзJson(ТипОбъекта: Тип, МассивСсылок: ЧитаемыйМассив<ВходящиеДанные.Ссылка>, ЗаданиеМодификации: ВебApiСервер.ЗаданиеМодификации)
;

@ВПроекте
@Реализация
метод ГруппаИзмененийВJson(ТипОбъекта: Тип, Ссылки: ЧитаемаяКоллекция<ИсходящиеДанные.Ссылка>,
    Сервисы: ВебApiСервер.СервисыУпаковкиJson, ВерсияФорматаОбмена: Версия?): Массив<ЧитаемоеСоответствие<Строка, Массив<Объект?>>>
    
    пер ДанныеJson: Массив<ЧитаемоеСоответствие<Строка, Массив<Объект?>>>
    выбор ТипОбъекта
    когда Тип<Анкеты.Ссылка>
        ДанныеJson.Добавить(АнкетыDto.ГруппаИзмененийВJson(Ссылки, Сервисы))
    когда Тип<Ответы.Ссылка>
        ДанныеJson.Добавить(ОтветыDto.ГруппаИзмененийВJson(Ссылки, Сервисы))
    когда Тип<Опросы.Ссылка>
        ДанныеJson.Добавить(ОпросыDto.ГруппаИзмененийВJson(Ссылки, Сервисы))
    когда Тип<ШаблоныАнкет.Ссылка>
        ДанныеJson.Добавить(ШаблоныАнкетDto.ГруппаИзмененийВJson(Ссылки, Сервисы, ВерсияФорматаОбмена))
    когда Тип<ВопросыШаблоновАнкет.Ссылка>
        ДанныеJson.Добавить(ВопросыШаблоновАнкетDto.ГруппаИзмененийВJson(Ссылки, Сервисы))
    когда Тип<Вопросы.Ссылка>
        ДанныеJson.Добавить(ВопросыDto.ГруппаИзмененийВJson(Ссылки, Сервисы))
    когда Тип<НаборыВариантовОтвета.Ссылка>
        ДанныеJson.Добавить(НаборыВариантовОтветаDto.ГруппаИзмененийВJson(Ссылки, Сервисы))
    когда Тип<РазделыАнкет.Ссылка>
        ДанныеJson.Добавить(РазделыАнкетDto.ГруппаИзмененийВJson(Ссылки, Сервисы))
    когда Тип<ВариантыОтветов.Ссылка>
        ДанныеJson.Добавить(ВариантыОтветовDto.ГруппаИзмененийВJson(Ссылки, Сервисы))
    ;
    возврат ДанныеJson
;

//Конец ДанныеApi

// Контракт ПредопределенныеЗначенияОтветовApi

@ВПроекте
@Реализация
метод ВнешняяСсылка(ОписаниеЭлемента: ОбменДанными.ЭлементКонтрактаСущностиJson): ВебApiСервер.ВнешняяСсылка?
    если ОписаниеЭлемента.typeName == Тип<ВариантыОтветов>.Представление()
        возврат ВариантыОтветовDto.ВнешняяСсылка(ОписаниеЭлемента.ID)
    иначе
        возврат Неопределено
    ;        
;

@ВПроекте
@Реализация
метод ОписаниеЭлемента(Ссылка: ПредопределенныеЗначенияОтветов.Ссылка, Сервисы: ВебApiСервер.СервисыУпаковкиJson): ОбменДанными.ЭлементКонтрактаСущностиJson?
    если Ссылка это ВариантыОтветов.Ссылка
        возврат новый ОбменДанными.ЭлементКонтрактаСущностиJson(
            typeName = Тип<ВариантыОтветов>.Представление(),
            ID = Сервисы.ПолучитьИдентификатор(Ссылка как ВариантыОтветов.Ссылка)
        )    
    иначе
        возврат Неопределено
    ;    
;

// Конец ПредопределенныеЗначенияОтветовApi