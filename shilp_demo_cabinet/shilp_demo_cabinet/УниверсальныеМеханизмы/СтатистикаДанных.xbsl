импорт ОбщиеСтандартные

@ВПроекте
структура Справочник
    пер ТипСправочника: Строка
    пер ИмяСправочника: Строка
    пер Количество: Число
;

@ВПроекте
структура Документ
    пер ТипДокумента: Строка
    пер ИмяДокумента: Строка
    пер Статус: СостоянияДокумента
    пер Дата: Дата
    пер Количество: Число
;

@ВПроекте
метод СтатистикаПоСправочнику(Справочник: Тип): Справочник
    пер СправочникСтатистика: Справочник
    
    пер ИмяСправочника: Строка = МенеджерСущности.ИмяТаблицыПоТипу(Справочник)
    пер Запрос = новый ПроизвольныйЗапрос(
        "Выбрать 
            Количество(*) Как КоличествоЭлементов 
        Из
            %ИмяСправочника")
    исп РезультатЗапроса = Запрос.Выполнить()
    знч РезультатЗапросаСтроки = новый ЧитаемыйМассив(РезультатЗапроса)
    если (не РезультатЗапросаСтроки.Пусто())
        СправочникСтатистика = новый Справочник(
            ИмяСправочника,
            ИмяСправочника,
            РезультатЗапросаСтроки[0].КоличествоЭлементов)
    ;
    возврат СправочникСтатистика    
;

@ВПроекте
метод СтатистикаПоДокументу(ДокументМенеджер: неизвестно): ЧитаемыйМассив<Документ>
    пер ДокументСтатистика: Документ
    знч ДокументыСтатистика: Массив<Документ> 
    пер ИмяДокумента: Строка = МенеджерСущности.ИмяТаблицыПоСсылке(ДокументМенеджер.ПолучитьСсылку(новый Ууид()))
    пер Запрос = новый ПроизвольныйЗапрос(
        "Выбрать 
            Документы.МесяцСоздания Как МесяцСоздания,
            СостояниеДокументов.Состояние.ЗаменитьNull(СостоянияДокумента.Черновик) Как Состояние,      
            Количество(*) Как КоличествоЭлементов 
        Из %ИмяДокумента Как Документы
        Левое Соединение СостояниеДокументов Как СостояниеДокументов
        По СостояниеДокументов.Документ == Документы.Ссылка
        Где Документы.МесяцСоздания != Неопределено 
        Сгруппировать По 
            Документы.МесяцСоздания,
            СостояниеДокументов.Состояние")
    исп РезультатЗапроса = Запрос.Выполнить()
    для РезультатЗапросаСтрока из РезультатЗапроса
        ДокументСтатистика = новый СтатистикаДанных.Документ(
            ИмяДокумента, 
            ИмяДокумента, 
            РезультатЗапросаСтрока.Состояние, 
            РезультатЗапросаСтрока.МесяцСоздания,  
            РезультатЗапросаСтрока.КоличествоЭлементов)
        ДокументыСтатистика.Добавить(ДокументСтатистика)
    ;
    возврат ДокументыСтатистика
;