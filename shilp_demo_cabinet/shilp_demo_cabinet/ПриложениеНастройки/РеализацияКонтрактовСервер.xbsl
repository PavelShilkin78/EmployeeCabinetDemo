импорт ВебApi
импорт ЛичныеКабинетыПользователей
импорт СтандартноеПриложение
импорт Анкетирование
импорт Обсуждения
импорт Уведомления
импорт ОбменДанными
импорт Криптография
импорт Компания
импорт ФизическиеЛица
импорт ВладельцыКабинетов
импорт ПодборПерсонала
импорт АдаптацияПерсонала
импорт Тестирование
импорт КонтрольДоступа
импорт УниверсальныеМеханизмы
импорт ВзаимодействиеСEssm

// Контракт ПодсистемаПриложения

@ВПроекте
@Реализация
метод ОписаниеПодсистемы(): СтандартноеПриложение.ОписаниеПодсистемы
    возврат новый СтандартноеПриложение.ОписаниеПодсистемы(
        ПриложениеНастройки.ИД_ПОДСИСТЕМЫ,
        {
            Анкетирование.ИД_ПОДСИСТЕМЫ, 
            КонтрольДоступа.ИД_ПОДСИСТЕМЫ,
            Обсуждения.ИД_ПОДСИСТЕМЫ,
            Уведомления.ИД_ПОДСИСТЕМЫ,
            ОбменДанными.ИД_ПОДСИСТЕМЫ,
            Криптография.ИД_ПОДСИСТЕМЫ,
            Компания.ИД_ПОДСИСТЕМЫ,
            ФизЛица.ИД_ПОДСИСТЕМЫ,
            ВладельцыКабинетов.ИД_ПОДСИСТЕМЫ,
            ЛичныеКабинетыПользователей.ИД_ПОДСИСТЕМЫ,
            ПодборПерсонала.ИД_ПОДСИСТЕМЫ,
            АдаптацияПерсонала.ИД_ПОДСИСТЕМЫ,
            Тестирование.ИД_ПОДСИСТЕМЫ,
            УниверсальныеМеханизмы.ИД_ПОДСИСТЕМЫ
        }
    )
;

// Конец ПодсистемаПриложения

// Контракт ОбновляемаяПодсистема

@ВПроекте
@Реализация
метод ОбработчикиЗаполнения(): Массив<СтандартноеПриложение.ОписаниеОбработчикаЗаполнения>
    возврат []
;

@ВПроекте
@Реализация
метод ОбработчикиОбновления(): Массив<СтандартноеПриложение.ОписаниеОбработчикаОбновления>
    пер Обработчики: Массив<СтандартноеПриложение.ОписаниеОбработчикаОбновления>
    Обработчики.Добавить(новый СтандартноеПриложение.ОписаниеОбработчикаОбновления(
                ПриложениеНастройки.ИД_ПОДСИСТЕМЫ, 
                "ПеренестиНастройкиВоВзаимодействиеСEssm",
                &ПеренестиНастройкиВоВзаимодействиеСEssm(),
                Версия{7.1.1.25}))
    возврат Обработчики
;

// Конец ОбновляемаяПодсистема

// Контракт ЛичныеКабинетыПоставщик
@ВПроекте
@Реализация
метод ИдEssWelcome():Строка
    исп ПривилегированныйРежим = КонтекстДоступа.Привилегированный()
    знч НастройкиПриложения = МенеджерНастроекПриложения.НастройкиПриложения()
    ПривилегированныйРежим.Закрыть()
    возврат НастройкиПриложения.ИдEssWelcome
;

@ВПроекте
@Реализация
метод ОбновитьСтроковыеРесурсы()
    знч СозданКабинетEmail =
        "<html lang='ru-RU'>
        <head>
        <meta charset='utf-8'>
        </head>
        <body style='font-family:Arial;background:lightgrey: text-align: center'>
        <div style='min-width: 280px;max-width: 680px; margin: 0 auto'>
        <div style='height: 48px;background:whitesmoke;'>
        <p style='text-align: center;color:darkgray; padding: 16px;'><b>1С:Кабинет сотрудника</b></p>
        </div>
        <div style='background:white; padding: 8px 24px;'>
        <h2>\%ИмяОтчество\%!</h2>
        <p>Для вас создан личный кабинет сотрудника.<br>
        Ваше имя для входа в личный кабинет (логин): <b>\%ЛогинПользователя\%</b></p>
        <p>Чтобы войти в личный кабинет:</p>
        <ul>
        <li>Установите приложение <b>1С:Кабинет сотрудника</b> из Google Play, App Store, RuStore или AppGallery на ваш смартфон или планшет</li>
        </ul>
        <p style='text-align: center'>
        <a style='text-decoration: none' href='https://play.google.com/store/apps/details?id=com.e1c.mobile.ess'>
        <img style='height: 36px' src='\%КартинкаGooglePlay\%'>
        </a>
        &nbsp;&nbsp;
        <a style='text-decoration: none' href='https://apps.apple.com/ru/app/1\%D1\%81-\%D0\%BA\%D0\%B0\%D0\%B1\%D0\%B8\%D0\%BD\%D0\%B5\%D1\%82-\%D1\%81\%D0\%BE\%D1\%82\%D1\%80\%D1\%83\%D0\%B4\%D0\%BD\%D0\%B8\%D0\%BA\%D0\%B0/id1484765318'>
        <img style='height: 36px' src='\%КартинкаAppStore\%'>
        </a>
        &nbsp;&nbsp;
        <a style='text-decoration: none' href='https://www.rustore.ru/catalog/app/com.e1c.mobile.ess'>
        <img style='height: 36px' src='\%КартинкаRuStore\%'>
        </a>
        &nbsp;&nbsp;
        <a style='text-decoration: none' href='https://appgallery.huawei.com/#/app/C107652977'>
        <img style='height: 36px' src='\%КартинкаAppGallery\%'>
        </a></p>
        <ul>
        <li>Запустите приложение</li>
        </ul>
        <p style='text-align: center'>
        <img style='width: 80px' src='\%ЛоготипПриложения\%'></p>
        <ul>
        <li>Введите ключ активации</li>
        </ul>
        <p style='text-align: center; font-size: xx-large;'><b>\%КлючАктивации\%</b></p>
        <ul>
        <li>...или активируйте приложение при  помощи QR-кода</li>
        </ul>
        <p style='text-align: center'>
        <img style='height: 200px' src='\%QRКодАктивации\%'></p>
        </div>
        <div style='background:whitesmoke; padding: 8px 24px;'>
        <div style='float: left; width: 7%;'>
        <p><b>PS</b></p>
        </div>
        <div style='margin-left: 7%;'>
        <p style='font-size: small;'>Если Вы не хотите или не можете установить приложение на свое устройство, войдите в свой личный кабинет через браузер.</p>
        </div>
        <p style='text-align: center;' >
        <a style='text-decoration: none' href='\%СсылкаСЛогином\%'><b>ОТКРЫТЬ В БРАУЗЕРЕ</b></a></p>
        </div>
        </div>
        </body>
        </html>"
    пер Комментарий = "Уведомление о создании личного кабинета, оправляемое по email"
    УниверсальныеМеханизмы.ЗаписатьЗначениеРесурса(ЛичныеКабинетыПользователей.ГРУППА_РЕСУРСОВ_ЛК, ЛичныеКабинетыПользователей.СОЗДАН_КАБИНЕТ_EMAIL, Комментарий, СозданКабинетEmail)
    
    знч СозданКабинетSms = "\%ИмяОтчество\%! Для вас создан личный кабинет сотрудника. Ваше имя для входа в личный кабинет (логин) – \%ЛогинПользователя\%. Установите приложение 1С:Кабинет сотрудника из магазина приложений вашего устройства и используйте для него ключ активации \%КлючАктивации\%."
    Комментарий = "Уведомление о создании личного кабинета, оправляемое как sms"
    УниверсальныеМеханизмы.ЗаписатьЗначениеРесурса(ЛичныеКабинетыПользователей.ГРУППА_РЕСУРСОВ_ЛК, ЛичныеКабинетыПользователей.СОЗДАН_КАБИНЕТ_SMS, Комментарий, СозданКабинетSms)
    
    знч СозданКабинетЗаголовок = "Доступ к личному кабинету"
    Комментарий = "Тема письма о создании личного кабинета"
    УниверсальныеМеханизмы.ЗаписатьЗначениеРесурса(ЛичныеКабинетыПользователей.ГРУППА_РЕСУРСОВ_ЛК, ЛичныеКабинетыПользователей.СОЗДАН_КАБИНЕТ_ЗАГОЛОВОК, Комментарий, СозданКабинетЗаголовок)
    
    знч ПодключенСервисЗаголовок = "Подключен сервис 1С:Кабинет сотрудника"
    Комментарий = "Тема письма о подключении сервиса 1С:Кабинет сотрудника"
    УниверсальныеМеханизмы.ЗаписатьЗначениеРесурса(ЛичныеКабинетыПользователей.ГРУППА_РЕСУРСОВ_ЛК, ЛичныеКабинетыПользователей.ПОДКЛЮЧЕН_СЕРВИС_ЗАГОЛОВОК, Комментарий, ПодключенСервисЗаголовок)
    
    знч ПодключенСервисEmail = 
        "\%ИмяОтчество\%!
        Ваша информационная система подключена к сервису 1С:Кабинет сотрудника.
        Для создания личных кабинетов сотрудников вашей организации и для настройки работы сервиса используйте браузер вашего компьютера или ноутбука. Для этого перейдите по ссылке \%СсылкаСЛогином\%. Вам придет sms (или письмо на электронную почту) с четырехзначным кодом подтверждения. После его ввода придумайте и дважды введите пароль от своего личного кабинета.
        В разделе Администрирование вы сможете создать кабинеты своим сотрудникам (ваш кабинет уже создан). После этого можно будет разослать сотрудникам приглашения с ключом активации мобильного приложения.
        Не забудьте и про себя - отправьте себе приглашение с ключом активации мобильного приложения.
        
        С уважением, 
        разработчики сервиса 1С:Кабинет сотрудника."
    Комментарий = "Уведомление о подключении сервиса 1С:Кабинет сотрудника, отправляеме по email"
    УниверсальныеМеханизмы.ЗаписатьЗначениеРесурса(ЛичныеКабинетыПользователей.ГРУППА_РЕСУРСОВ_ЛК, ЛичныеКабинетыПользователей.ПОДКЛЮЧЕН_СЕРВИС_EMAIL, Комментарий, ПодключенСервисEmail)
;

//ЛичныеКабинетыПоставщик

// Контракт СтроковыеРесурсыПоставщик

@ВПроекте
@Реализация
метод ИменаРесурсовПоГруппеРесурсов(УчитыватьИспользуемуюФункциональность: Булево): Соответствие<Строка, Коллекция<Строка>>
    возврат {
        ЛичныеКабинетыПользователей.ГРУППА_РЕСУРСОВ_ЛК: [
            ЛичныеКабинетыПользователей.СОЗДАН_КАБИНЕТ_EMAIL,
            ЛичныеКабинетыПользователей.СОЗДАН_КАБИНЕТ_SMS,
            ЛичныеКабинетыПользователей.СОЗДАН_КАБИНЕТ_ЗАГОЛОВОК,
            ЛичныеКабинетыПользователей.ПОДКЛЮЧЕН_СЕРВИС_ЗАГОЛОВОК,
            ЛичныеКабинетыПользователей.ПОДКЛЮЧЕН_СЕРВИС_EMAIL]
    }
;

// Конец СтроковыеРесурсыПоставщик

// Контракт НастраиваемоеСервисомПриложение

@ВПроекте
@Реализация
метод ИнформацияОПриложении(): ПредоставляемаяСервисомИнформацияОПриложении?
    знч Сервис = ИнформацияОПриложении.ПолучитьСервис()
    возврат новый ИнформацияОПриложенииJson(
        Сервис.ИдентификаторПриложения(),
        Сервис.Версия().ВСтроку())
;

@ВПроекте
@Реализация
метод УстановитьНастройкиПриложения(Настройки: ОпределяемыеСервисомНастройкиПриложения, Ключи: ЧитаемаяКоллекция<Строка>? = Неопределено)
    
    знч НастройкиJson = Настройки как НастройкиПриложенияJson
    исп КонтекстДоступа.Привилегированный()
    МенеджерНастроекПриложения.СохранитьНастройкиПриложенияИзJson(НастройкиJson, Ключи)

;

@ВПроекте
@Реализация
метод УстановитьНастройкиДляОблачногоРежимаРаботы(Настройки: ОпределяемыеСервисомНастройкиПриложения, Ключи: ЧитаемаяКоллекция<Строка>? = Неопределено)
    
    знч НастройкиJson = Настройки как НастройкиПриложенияJson
    исп КонтекстДоступа.Привилегированный()
    МенеджерНастроекПриложения.СохранитьНастройкиДляОблачногоРежимаРаботыИзJson(НастройкиJson, Ключи)

;

@ВПроекте
@Реализация
метод УстановитьДоступностьПриложения(Доступность: ОпределяемаяСервисомДоступностьПриложения)
    
    знч ДоступностьJson = Доступность как ДоступностьПриложенияJson
    знч ДоступностьНастройка = новый ДоступностьПриложения.ДанныеДоступностиПриложения(
        ДоступПользователей = ДоступностьПриложенияJson.СостояниеДоступностиИзJson(ДоступностьJson.userAccess), 
        ДоступИнформационныхСистем = ДоступностьПриложенияJson.СостояниеДоступностиИзJson(ДоступностьJson.infosystemAccess)
    )
        
    ДоступностьПриложения.УстановитьДоступностьПриложения(ДоступностьНастройка)
;

@ВПроекте
@Реализация
метод ИнформацияОДоступностиПриложения(): ОпределяемаяСервисомДоступностьПриложения?
    знч ДоступностьНастройка = ДоступностьПриложения.ДанныеДоступностиПриложения()
    возврат новый ДоступностьПриложенияJson(
        userAccess = ДоступностьПриложенияJson.СостояниеДоступностиВJson(ДоступностьНастройка.ДоступПользователей), 
        infosystemAccess = ДоступностьПриложенияJson.СостояниеДоступностиВJson(ДоступностьНастройка.ДоступИнформационныхСистем)
    )
;

// Контракт НастраиваемоеСервисомПриложение


метод ПеренестиНастройкиВоВзаимодействиеСEssm()
    знч Запрос = Запрос{
        Выбрать Первые 1
            УдалитьАдресСервераEssm,
            УдалитьИмяПриложенияEssm,
            УдалитьИдКлиентаEssm,
            УдалитьСекретКлиентаEssm
        Из НастройкиПриложения}
    исп РезультатЗапроса = Запрос.Выполнить()
    пер ПараметрыДоступаКEssm: ВзаимодействиеСEssm.ПараметрыДоступаКEssm
    для СтрокаРезультата из РезультатЗапроса
        ПараметрыДоступаКEssm = новый ВзаимодействиеСEssm.ПараметрыДоступаКEssm(
                АдресСервераEssm = СтрокаРезультата.УдалитьАдресСервераEssm,
                ИмяПриложенияEssm = СтрокаРезультата.УдалитьИмяПриложенияEssm,
                ИдКлиентаEssm = СтрокаРезультата.УдалитьИдКлиентаEssm,
                СекретКлиентаEssm = СтрокаРезультата.УдалитьСекретКлиентаEssm)
    ;
    ВзаимодействиеСEssm.СохранитьПараметрыДоступаКEssm(ПараметрыДоступаКEssm)
;
